<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Handwritten Physics → LaTeX</title>

<style>
    body {
        font-family: Arial;
        background: #111;
        color: #eee;
        padding: 20px;
    }
    #container {
        max-width: 800px;
        margin: auto;
        background: #222;
        padding: 20px;
        border-radius: 8px;
    }
    h1 {
        color: #6cf;
        text-align: center;
    }
    input, button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
    }
    button {
        background: #6cf;
        font-weight: bold;
    }
    #output {
        margin-top: 20px;
        padding: 15px;
        background: #333;
        border-radius: 8px;
        white-space: pre-wrap;
    }
</style>
</head>

<body>
<div id="container">

<h1>Handwritten Physics → LaTeX</h1>

<input type="file" id="fileInput" accept="image/*,application/pdf">

<button onclick="startOCR()">Convert</button>

<div id="output">Upload a PDF or image to begin.</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

<script>

// SAFELY load token:
const token = window.REPLICATE_API_TOKEN || "";  
if (!token) {
    console.warn("⚠️ No Replicate token found. Add it in Netlify environment variables as REPLICATE_API_TOKEN");
}

// Replicate helper:
async function callReplicate(modelVer, inputData) {
    const res = await fetch("https://api.replicate.com/v1/predictions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Token " + token
        },
        body: JSON.stringify({
            version: modelVer,
            input: inputData
        })
    });

    let pred = await res.json();
    while (pred.status !== "succeeded" && pred.status !== "failed") {
        await new Promise(r => setTimeout(r, 1500));
        let check = await fetch(
            "https://api.replicate.com/v1/predictions/" + pred.id,
            { headers: { "Authorization": "Token " + token } }
        );
        pred = await check.json();
    }
    if (pred.status === "failed") throw new Error(pred.error);
    return pred.output;
}

// Convert PDF → array of image dataURLs
async function pdfToImages(file) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    const images = [];

    for (let i = 1; i <= pdf.numPages; i++) {
        let page = await pdf.getPage(i);
        let viewport = page.getViewport({ scale: 2 });

        let canvas = document.createElement("canvas");
        let ctx = canvas.getContext("2d");

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: ctx, viewport }).promise;
        images.push(canvas.toDataURL("image/png"));
    }

    return images;
}

async function startOCR() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
        alert("Upload something first!");
        return;
    }

    document.getElementById("output").textContent = "Processing...";

    let pages = [];

    if (file.type === "application/pdf") {
        pages = await pdfToImages(file);
    } else {
        pages = [ await fileToBase64(file) ];
    }

    let finalLatex = "";

    for (let img of pages) {
        // STEP 1: Layout detection
        const layout = await callReplicate(
            "67c28e4198439d7c8deba93628337d6730d2bc47b15f4f4ab316eaef697088b4",
            { image: img }
        );

        for (let block of layout.blocks) {

            let crop = block.crop;

            if (block.type === "equation") {
                // Equation → LaTeX
                const latex = await callReplicate(
                    "495cc6e8d68bc85ce32a4112b226206d9e5d1133cc7e4ca1e1d1fa036d7ff352",
                    { image: crop }
                );

                finalLatex += "\n$$ " + latex + " $$\n\n";

            } else {
                // Handwriting → text
                const text = await callReplicate(
                    "575d1f7b0168afebcad6f4a0d63d93a2b28b4da60979aefc54f110b56fafa6f4",
                    { image: crop }
                );

                finalLatex += text + "\n\n";
            }
        }
    }

    document.getElementById("output").textContent = finalLatex;
}

function fileToBase64(file) {
    return new Promise((resolve) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.readAsDataURL(file);
    });
}

</script>

</body>
</html>
